import {
  BaseApplicationCustomizer,
  PlaceholderName,
  PlaceholderContent
} from '@microsoft/sp-application-base';
import { sp } from "@pnp/sp";
import "@pnp/sp/webs";
import "@pnp/sp/lists";
import "@pnp/sp/items";
import "@pnp/sp/site-users/web";

interface INavigationItem {
  id: number;
  title: string;
  url: string;
  parent: string;
  order: number;
  isActive: boolean;
  description: string;
  children: INavigationItem[];
}

export default class HeaderExtensionApplicationCustomizer
  extends BaseApplicationCustomizer<any> {

  private topPlaceholder: PlaceholderContent | undefined;

  public onInit(): Promise<void> {
    sp.setup({
      spfxContext: this.context as any
    });
    this.context.placeholderProvider.changedEvent.add(this, this.renderCustomHeader);
    return Promise.resolve();
  }

  private toggleMenu(): void {
    const nav = document.querySelector('.navigation') as HTMLElement;
    if (nav) nav.classList.toggle('active');
  }

  private async fetchNavigationData(): Promise<INavigationItem[]> {
    try {
      const items = await sp.web.lists.getByTitle("NavigationMenu")
        .items.select(
          "ID",
          "GP_PrimaryLinkTitle",
          "GP_PrimaryLinkURL",
          "GP_PrimaryParent",
          "GP_Order",
          "GP_IsActive",
          "GP_Description"
        )
        .filter("GP_IsActive eq 'Yes'")
        .orderBy("GP_Order", true)
        .get();

      return this.buildNavigationHierarchy(items);
    } catch (error) {
      console.error("Error fetching navigation:", error);
      return [];
    }
  }

  private buildNavigationHierarchy(items: any[]): INavigationItem[] {
    const itemsMap = new Map<string, INavigationItem>();
    const rootItems: INavigationItem[] = [];

    items.forEach(item => {
      itemsMap.set(item.GP_PrimaryLinkTitle, {
        id: item.ID,
        title: item.GP_PrimaryLinkTitle,
        url: item.GP_PrimaryLinkURL?.Url || '',
        parent: item.GP_PrimaryParent,
        order: item.GP_Order || 0,
        isActive: item.GP_IsActive === 'Yes',
        description: item.GP_Description || '',
        children: []
      });
    });

    items.forEach(item => {
      const currentItem = itemsMap.get(item.GP_PrimaryLinkTitle);
      if (currentItem) {
        if (item.GP_PrimaryParent) {
          const parentItem = itemsMap.get(item.GP_PrimaryParent);
          if (parentItem) {
            parentItem.children.push(currentItem);
          }
        } else {
          rootItems.push(currentItem);
        }
      }
    });

    return this.sortNavigationItems(rootItems);
  }

  private sortNavigationItems(items: INavigationItem[]): INavigationItem[] {
    items.sort((a, b) => a.order - b.order);
    items.forEach(item => {
      if (item.children.length > 0) {
        item.children = this.sortNavigationItems(item.children);
      }
    });
    return items;
  }

  private generateNavigationHTML(items: INavigationItem[]): string {
    return items.map(item => {
      const hasChildren = item.children.length > 0;
      const mainLinkOnClick = item.url ? ` onclick="window.open('${item.url}', '_blank'); return false;"` : '';
      const titleWithDescription = item.description ? ` title="${item.description}"` : '';

      return `
        <li class="${hasChildren ? 'has-dropdown' : ''}"${titleWithDescription}>
          <a href="javascript:void(0);"${mainLinkOnClick}>
            ${item.title}${hasChildren ? ' <span class="dropdown-arrow">â–¼</span>' : ''}
          </a>
          ${hasChildren ? `
            <ul class="dropdown">
              ${this.generateNavigationHTML(item.children)}
            </ul>
          ` : ''}
        </li>
      `;
    }).join('');
  }

  private async renderCustomHeader(): Promise<void> {
    if (this.topPlaceholder) return;

    this.topPlaceholder = this.context.placeholderProvider.tryCreateContent(PlaceholderName.Top);
    if (!this.topPlaceholder?.domElement) return;

    const imageUrl = `${this.context.pageContext.web.absoluteUrl}/SiteAssets/GPLogo.png`;
    const navigationItems = await this.fetchNavigationData();
    const currentUser = await this.fetchCurrentUser();

    this.topPlaceholder.domElement.innerHTML = `
      <header class="header">
        <div class="header-content">
          <div class="left-section">
            <button class="hamburger" aria-label="Toggle menu">
              <span></span>
              <span></span>
              <span></span>
            </button>
            <div class="logo">
              <img src="${imageUrl}" alt="Logo">
            </div>
          </div>
          <nav class="navigation">
            <ul>
              ${this.generateNavigationHTML(navigationItems)}
            </ul>
          </nav>
          ${currentUser ? `
          <div class="user-section">
            <div class="user-info">
              <span class="user-name">${currentUser.name}</span>
              <img src="${currentUser.picture}" alt="${currentUser.name}" class="user-image">
            </div>
          </div>
          ` : ''}
        </div>
      </header>
      <style>
        .header {
          background-color: white;
          color: #2A3440;
          height: 57px;
          display: flex;
          align-items: center;
          box-shadow: 0 2px 4px rgba(0,0,0,0.1);
          position: relative;
          z-index: 1000;
          width: 100%;
        }

        .header-content {
          display: flex;
          align-items: center;
          width: 100%;
          padding: 0 20px;
        }

        .left-section {
          display: flex;
          align-items: center;
          gap: 15px;
        }

        .logo img {
          height: 45px;
          width: 93.19px;
        }

        .navigation {
          flex-grow: 1;
          margin-left: 40px;
        }

        .navigation ul {
          list-style: none;
          display: flex;
          margin: 0;
          padding: 0;
          gap: 40px;
        }

        .navigation li {
          position: relative;
        }

        .navigation a {
          color: #2A3440;
          text-decoration: none;
          font-weight: 500;
          font-family: 'Barlow';
          font-size: 14.22px;
          padding: 8px 16px;
          display: block;
          white-space: nowrap;
        }

        .navigation > ul > li > .dropdown {
          display: none;
          position: absolute;
          top: 100%;
          left: 0;
          background: white;
          min-width: 200px;
          box-shadow: 0 4px 8px rgba(0,0,0,0.1);
          z-index: 1000;
          padding: 8px 0;
        }

        .dropdown .dropdown {
          display: none;
          position: absolute;
          top: 0;
          left: 100%;
          margin-left: 0;
        }

        .navigation > ul > li:hover > .dropdown,
        .dropdown li:hover > .dropdown {
          display: block;
        }

        .dropdown li {
          width: 100%;
        }

        .dropdown a {
          padding: 8px 16px;
          display: block;
          color: #2A3440;
          text-decoration: none;
        }

        .dropdown li:hover > a {
          background-color: #f5f5f5;
          color: #0078d4;
        }

        .dropdown-arrow {
          font-size: 8px;
          margin-left: 4px;
          transition: transform 0.2s;
        }

        .has-dropdown:hover .dropdown-arrow {
          transform: rotate(180deg);
        }

        .user-section {
          margin-left: auto;
          padding-left: 20px;
        }

        .user-info {
          display: flex;
          align-items: center;
          gap: 10px;
        }

        .user-name {
          color: #2A3440;
          font-family: 'Barlow';
          font-size: 14px;
          font-weight: 500;
        }

        .user-image {
          width: 32px;
          height: 32px;
          border-radius: 50%;
          object-fit: cover;
        }

        .hamburger {
          display: none;
        }

        @media (max-width: 768px) {
          .hamburger {
            display: flex;
            flex-direction: column;
            gap: 4px;
            background: none;
            border: none;
            padding: 8px;
            cursor: pointer;
          }

          .hamburger span {
            display: block;
            width: 24px;
            height: 2px;
            background: #2A3440;
          }

          .navigation {
            display: none;
            position: absolute;
            top: 57px;
            left: 0;
            width: 100%;
            background: white;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
          }

          .navigation.active {
            display: block;
          }

          .navigation ul {
            flex-direction: column;
            gap: 10px;
          }

          .dropdown {
            position: static !important;
            display: none;
            box-shadow: none !important;
            padding-left: 20px !important;
          }

          .has-dropdown.active > .dropdown {
            display: block;
          }
        }
      </style>
    `;

    const hamburger = this.topPlaceholder.domElement.querySelector('.hamburger');
    if (hamburger) {
      hamburger.addEventListener('click', () => this.toggleMenu());
    }

    const dropdowns = this.topPlaceholder.domElement.querySelectorAll('.has-dropdown');
    dropdowns.forEach(dropdown => {
      dropdown.addEventListener('click', (e) => {
        if (window.innerWidth <= 768) {
          e.preventDefault();
          dropdown.classList.toggle('active');
        }
      });
    });
  }

  private async fetchCurrentUser() {
    try {
      const user = await sp.web.currentUser.get();
      return {
        name: user.Title,
        email: user.Email,
        picture: `${this.context.pageContext.web.absoluteUrl}/_layouts/15/userphoto.aspx?size=S&accountname=${user.Email}`
      };
    } catch (error) {
      console.error("Error fetching user:", error);
      return null;
    }
  }
}